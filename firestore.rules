rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== HELPER FUNCTIONS =====
    
    // Check if user is authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // Check if user owns this resource
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    // ===== USER DATA =====
    
    // Users can only read and write their own data
    match /users/{userId} {
      // Allow users to read their own document
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
      
      // Private data - only owner can access
      match /recipes/{recipeId} {
        allow read, write: if isOwner(userId);
      }
      
      match /books/{bookId} {
        allow read, write: if isOwner(userId);
      }
      
      match /categories/{categoryId} {
        allow read, write: if isOwner(userId);
      }
      
      match /settings/{settingId} {
        allow read, write: if isOwner(userId);
      }
      
      // v4.1 - Equipment collection
      match /equipment/{equipmentId} {
        allow read, write: if isOwner(userId);
      }
      
      // v4.1 - Pantry collection
      match /pantry/{pantryId} {
        allow read, write: if isOwner(userId);
      }
      
      // v4.0 - Social features
      // Friends collection - CRITICAL: Allow other users to add themselves as friends
      // This is needed when someone accepts a friend request
      match /friends/{friendId} {
        // Owner can read/write their own friends list
        allow read: if isOwner(userId);
        allow write: if isOwner(userId);
        // Allow ANY authenticated user to CREATE a friend entry
        // This enables two-way friendship when accepting requests
        // The friendUid field should match the auth user when creating
        allow create: if isAuth() && request.resource.data.friendUid == request.auth.uid;
      }
      
      match /sharedRecipes/{shareId} {
        allow read, write: if isOwner(userId);
      }
      
      // Received recipes from friends
      match /receivedRecipes/{recipeId} {
        allow read, write: if isOwner(userId);
        // Allow authenticated users to send recipes
        allow create: if isAuth();
      }
      
      // Public profile data
      match /publicProfile/{docId} {
        allow read: if isAuth();
        allow write: if isOwner(userId);
      }
    }
    
    // ===== FRIEND REQUESTS (TOP LEVEL) =====
    // Allows any authenticated user to create friend requests
    // Users can read requests where they are the recipient
    match /friendRequests/{requestId} {
      allow create: if isAuth();
      allow read: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
      allow update, delete: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
    }
    
    // ===== SHARED RECIPES (TOP LEVEL) =====
    // Allows sharing recipes between users
    match /sharedRecipes/{shareId} {
      // Anyone authenticated can create a share (to send a recipe)
      allow create: if isAuth();
      // Can read if you are sender or recipient
      allow read: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
      // Can update/delete if you are sender or recipient
      allow update, delete: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
    }

    // ===== SHARED COOKBOOKS (TOP LEVEL) =====
    // Allows sharing cookbooks between users
    match /sharedCookbooks/{shareId} {
      // Anyone authenticated can create a share (to send a cookbook)
      allow create: if isAuth();
      // Can read if you are sender or recipient
      allow read: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
      // Can update/delete if you are sender or recipient
      allow update, delete: if isAuth() && (
        resource.data.fromUid == request.auth.uid ||
        resource.data.toUid == request.auth.uid
      );
    }
    
    // ===== PUBLIC LEADERBOARD =====
    
    // Leaderboard - readable by all authenticated users
    match /leaderboard/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);
    }
    
    // ===== PUBLIC PROFILES =====
    
    // Public profiles - for finding users by email
    match /publicProfiles/{profileId} {
      allow read: if isAuth();
      allow write: if isAuth() && request.resource.data.uid == request.auth.uid;
      allow delete: if isAuth() && resource.data.uid == request.auth.uid;
    }
    
    // Also support publicUsers collection (legacy)
    match /publicUsers/{email} {
      allow read: if isAuth();
      allow write: if isAuth() && request.resource.data.uid == request.auth.uid;
      allow delete: if isAuth() && resource.data.uid == request.auth.uid;
    }
    
    // ===== PUSH SUBSCRIPTIONS =====
    match /pushSubscriptions/{subId} {
      // Allow create with userId matching auth
      allow create: if isAuth() && request.resource.data.userId == request.auth.uid;
      // Allow read/update/delete if userId matches
      allow read, update, delete: if isAuth() && resource.data.userId == request.auth.uid;
    }
  }
}
